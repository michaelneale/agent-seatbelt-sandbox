;; Sandbox profile: allow everything EXCEPT direct outbound network and sensitive dirs.
;; The process can only reach the network via localhost (where our proxy lives).
;; All child processes inherit this restriction.
;;
;; Parameters (pass via sandbox-exec -D):
;;   SECRETS_DIR — path to block (e.g. /Users/you/.secrets)

(version 1)
(allow default)

;; Block access to sensitive directories
(deny file-read* (subpath (param "SECRETS_DIR")))
(deny file-write* (subpath (param "SECRETS_DIR")))

;; Block all network, then poke holes for localhost + DNS
(deny network*)

;; DNS resolution via macOS system resolver (mDNSResponder)
(allow network-outbound (literal "/private/var/run/mDNSResponder"))

;; Unix domain sockets (used by various local services)
(allow network-outbound (remote unix-socket))

;; Localhost only — this is the only way out, through our proxy
(allow network-outbound (remote ip "localhost:*"))

;; Allow network-inbound on localhost (for local dev servers, LSPs, etc.)
(allow network-inbound (local ip "localhost:*"))
